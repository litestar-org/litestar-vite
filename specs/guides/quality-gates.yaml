# Quality Gates for litestar-vite
# Version: 0.16.0 (Intelligent Edition)
# Updated: 2026-01-06

# Intelligence Layer Configuration
intelligence:
  adaptive: true
  description: "Quality gates that adapt to project conventions and complexity"

  complexity_levels:
    simple:
      description: "CRUD, config change, single file"
      checkpoints: 6
      tools: ["Read", "Write", "Edit", "Bash"]

    medium:
      description: "New service, API endpoint, 2-3 files"
      checkpoints: 8
      tools: ["Read", "Write", "Edit", "Bash", "sequential_thinking"]

    complex:
      description: "Architecture change, multi-component, 5+ files"
      checkpoints: 10
      tools: ["Read", "Write", "Edit", "Bash", "thinkdeep", "planner", "context7"]

  pattern_library:
    path: "specs/guides/patterns/"
    consult_before_implementation: true
    extract_after_review: true

implementation_gates:
  - name: local_tests_pass
    command: "make test"
    required: true
    description: "All tests must pass before proceeding"

  - name: linting_clean
    command: "make lint"
    required: true
    description: "Zero linting errors allowed"

  - name: type_checking_pass
    command: "make type-check"
    required: true
    description: "Type checking must pass"

testing_gates:
  - name: coverage_90_percent
    threshold: 90
    scope: "modified_modules"
    description: "Modified modules must achieve 90%+ test coverage"

  - name: all_tests_pass
    command: "make test"
    required: true

  - name: parallel_execution_works
    command: "pytest -n auto"
    required: true
    description: "Tests must work in parallel execution"

  - name: n_plus_one_detection
    type: "custom"
    applicable_when: "database_operations"
    description: "Database operations must include N+1 query detection tests"

  - name: concurrent_access_safe
    type: "custom"
    applicable_when: "shared_state"
    description: "Shared state operations must include concurrent access tests"

documentation_gates:
  - name: anti_pattern_scan
    rules:
      - pattern: "from __future__ import annotations"
        severity: "error"
        message: "Use explicit stringification instead"

      - pattern: "Optional\\["
        severity: "error"
        message: "Use T | None (PEP 604) instead of Optional[T]"

      - pattern: "class Test"
        path: "tests/"
        severity: "error"
        message: "Use function-based pytest instead of class-based tests"

      - pattern: "hasattr\\(|getattr("
        severity: "warning"
        message: "Review defensive programming usage - use type guards"

  - name: guides_updated
    description: "specs/guides/ must reflect new patterns if introduced"

  - name: knowledge_captured
    description: "New patterns must be documented before archival"

  - name: pattern_compliance
    description: "Implementation must follow patterns from similar features"
    adaptive: true
    enforcement: |
      1. Before implementation, search specs/guides/patterns/ for similar patterns
      2. Follow established conventions (naming, structure, error handling)
      3. Document deviations with rationale in tmp/deviations.md
      4. During review, extract new patterns to pattern library

  - name: new_patterns_extracted
    description: "New patterns discovered during implementation are captured"
    enforcement: |
      1. Document new patterns in tmp/new-patterns.md during implementation
      2. During review, move to specs/guides/patterns/ with proper format
      3. Update pattern library README if architectural patterns

  - name: recent_patterns_documented
    patterns_to_capture:
      - "Props flattening in InertiaResponse._build_page_props()"
      - "AppHandler.is_initialized property for init checks"
      - "AppHandler.get_html_sync() for sync contexts"
      - "HTTP/2 support with h2 package fallback (RuntimeConfig.http2)"
      - "External dev server config (ExternalDevServer)"
      - "Port auto-selection for proxy modes"
      - "InertiaTypeGenConfig for page props type generation (v0.15)"
      - "HTMX helper utilities (addDirective, registerHtmxExtension, setHtmxDebug, swapJson)"
      - "SPAConfig.cache_transformed_html option"
      - "RuntimeConfig.start_dev_server option"
      - "Mode aliases: ssr/ssg->framework, inertia->hybrid"
      - "Inertia v2 features: defer(), clear_history(), encrypt_history"
      - "PaginationContainer protocol for scroll regions"
