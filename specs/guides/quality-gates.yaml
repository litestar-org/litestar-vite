# Quality Gates for litestar-vite
# Version: 0.15.0-beta.1
# Updated: 2025-12-07

implementation_gates:
  - name: local_tests_pass
    command: "make test"
    required: true
    description: "All tests must pass before proceeding"

  - name: linting_clean
    command: "make lint"
    required: true
    description: "Zero linting errors allowed"

  - name: type_checking_pass
    command: "make type-check"
    required: true
    description: "Type checking must pass"

testing_gates:
  - name: coverage_90_percent
    threshold: 90
    scope: "modified_modules"
    description: "Modified modules must achieve 90%+ test coverage"

  - name: all_tests_pass
    command: "make test"
    required: true

  - name: parallel_execution_works
    command: "pytest -n auto"
    required: true
    description: "Tests must work in parallel execution"

  - name: n_plus_one_detection
    type: "custom"
    applicable_when: "database_operations"
    description: "Database operations must include N+1 query detection tests"

  - name: concurrent_access_safe
    type: "custom"
    applicable_when: "shared_state"
    description: "Shared state operations must include concurrent access tests"

documentation_gates:
  - name: anti_pattern_scan
    rules:
      - pattern: "from __future__ import annotations"
        severity: "error"
        message: "Use explicit stringification instead"

      - pattern: "Optional\\["
        severity: "error"
        message: "Use T | None (PEP 604) instead of Optional[T]"

      - pattern: "class Test"
        path: "tests/"
        severity: "error"
        message: "Use function-based pytest instead of class-based tests"
        known_violations:
          - "src/py/tests/unit/inertia/test_request.py"
          - "src/py/tests/unit/inertia/test_response.py"
          - "src/py/tests/unit/test_plugin.py"
          - "src/py/tests/integration/test_optional_jinja.py"
          - "src/py/tests/unit/test_commands.py"
          - "src/py/tests/unit/test_executor.py"

      - pattern: "hasattr\\(|getattr("
        severity: "warning"
        message: "Review defensive programming usage - use type guards"

  - name: guides_updated
    description: "specs/guides/ must reflect new patterns if introduced"

  - name: knowledge_captured
    description: "New patterns must be documented before archival"

  - name: recent_patterns_documented
    patterns_to_capture:
      - "Props flattening in InertiaResponse._build_page_props()"
      - "ViteSPAHandler.is_initialized property for init checks"
      - "ViteSPAHandler.get_html_sync() for sync contexts"
      - "HTTP/2 support with h2 package fallback (RuntimeConfig.http2)"
      - "External dev server config (ExternalDevServer)"
      - "Port auto-selection for proxy modes"
      - "InertiaTypeGenConfig for page props type generation (v0.15)"
      - "HTMX helper utilities (addDirective, registerHtmxExtension, setHtmxDebug, swapJson)"
      - "SPAConfig.cache_transformed_html option"
      - "RuntimeConfig.start_dev_server option"
      - "Mode aliases: ssg->ssr, inertia->hybrid"
      - "Inertia v2 features: defer(), clear_history(), encrypt_history"
      - "PaginationContainer protocol for scroll regions"
