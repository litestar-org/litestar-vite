# Architecture Guide for litestar-vite

This document outlines the architectural patterns and conventions used in the `litestar-vite` project.

## Overview

The project follows a hybrid architecture combining a Python backend with a modern TypeScript frontend.

-   **Backend**: Built with [Litestar](https://litestar.dev/), a high-performance, asynchronous ASGI framework.
-   **Frontend**: Managed by [Vite](https://vitejs.dev/), a next-generation frontend build tool.
-   **Integration**: The backend and frontend are connected via a manifest file generated by Vite, allowing the Litestar backend to serve the correct, hash-named JS and CSS assets. The project also includes support for [Inertia.js](https://inertiajs.com/) to build single-page applications with server-side routing.

## Backend Architecture (Python/Litestar)

The backend code is located in `src/py/litestar_vite/`.

### Key Principles

-   **Asynchronous by Default**: All I/O-bound operations (database access, API calls) should be `async` to leverage Litestar's performance benefits.
-   **Dependency Injection**: Litestar's dependency injection is used to manage resources like database sessions and services. Dependencies should be defined in a reusable way.
-   **Configuration**: Configuration is managed through Pydantic models within the `config.py` files, allowing for type-safe and environment-aware settings.

### Configuration (`ViteConfig`)

The `ViteConfig` class in `config.py` controls the integration behavior. Key options include:

-   **`bundle_dir`**: Location of compiled assets (default: `public`).
-   **`resource_dir`**: Location of source assets (default: `resources`).
-   **`public_dir`**: Optional public directory for Vite (default: `public`).
-   **`hot_reload`**: Enable HMR (Hot Module Replacement) (default: derived from `ViteConfig` environment or `True`).
-   **`ssr_enabled`**: Enable Server-Side Rendering (default: `False`).
-   **`is_react`**: Enable React specific support (default: `False`).
-   **`asset_url` / `base_url`**: Base URLs for generating asset references and CDN builds.
-   **`deploy`**: CDN deploy settings (fsspec backend, delete-orphan toggle, manifest inclusion).
-   **`host`**, **`port`**, **`protocol`**: Connection details for the Vite development server.
-   **`run_command`**, **`build_command`**, **`install_command`**: Commands to manage the Vite lifecycle.
-   **`executor`**: The `JSExecutor` instance responsible for running the commands (e.g. `NodeExecutor`, `BunExecutor`).

Python is the source of truth: `set_environment()` now writes `.litestar-vite.json` (path exported via `LITESTAR_VITE_CONFIG_PATH`) containing `assetUrl`, `bundleDirectory`, `resourceDirectory`, `publicDir`, `manifest`, `ssrOutDir`, typegen paths, and deploy defaults. The JS plugin consumes this file to set defaults; only override in `vite.config.ts` when you intentionally diverge.

### Component Layers

While not strictly enforced, the backend aims to follow a layered approach:

1.  **Controllers/Route Handlers**: Defined in modules like `plugin.py` or `cli.py`. These are the entry points for HTTP requests or CLI commands. They are responsible for parsing input, calling the relevant services, and returning a response.
2.  **Services**: (Conceptual) Business logic should be encapsulated within service classes or functions. This project may not have explicit `Service` classes, but logic is often grouped by feature (e.g., `loader.py`, `config.py`).
3.  **Executors**: The `JSExecutor` abstraction in `executor.py` handles the execution of external JavaScript runtime commands, isolating the CLI logic from the specific runtime (Node, Bun, Deno, etc.).
4.  **Data Models / Schemas**: Pydantic or standard dataclasses are used for data validation and serialization.

## Frontend Architecture (TypeScript/Vite)

The core frontend code is located in `src/js/`. The `examples/` directory contains various frontend application examples (Vue, etc.).

### Key Principles

-   **Modularity**: Code is organized into modules and components.
-   **Type Safety**: TypeScript is used throughout to ensure type safety.
-   **Build Optimization**: Vite handles the development server (with HMR) and production builds. The configuration is in `vite.config.ts`.

### Vite Plugin Configuration

The `litestar-vite-plugin` (default export in `src/js/src/index.ts`) configures Vite to work with Litestar. Key options:

-   **`input`**: Entry points to compile (required).
-   **`assetUrl`**: Base path for asset URLs (default: `/static/`).
-   **`bundleDirectory`**: Output directory for assets (default: `public/dist`).
-   **`resourceDirectory`**: Source directory (default: `resources`).
-   **`hotFile`**: Path to the hot file for HMR (default: `public/hot`).
-   **`ssr`**: SSR entry point.
-   **`ssrOutputDirectory`**: Output directory for SSR bundle.
-   **`refresh`**: Configuration for full page reload on file changes.
-   **`detectTls`**: Utilize TLS certificates.
-   **`autoDetectIndex`**: Automatically detect `index.html` (default: `true`).

### Inertia.js Integration

For SPA-style applications, the project uses an Inertia.js integration. The backend components are located in `src/py/litestar_vite/inertia/`.

#### Core Components

-   **`InertiaPlugin`**: Registers the Inertia integration with Litestar.
-   **`InertiaResponse`**: The response class used to render Inertia pages.
-   **`InertiaRequest`**: Extends Litestar's request with Inertia-specific properties.
-   **`InertiaMiddleware`**: Handles the Inertia protocol (headers, shared data).

#### Helpers

-   **`InertiaRedirect`**, **`InertiaExternalRedirect`**: For handling redirects within Inertia.
-   **`InertiaBack`**: Redirect back to the previous page.
-   **`share`**: Share data with all Inertia responses.
-   **`lazy`**: Define lazy-loaded props.
-   **`error`**: Flash error messages.

## Communication

-   **Vite Manifest**: The `ViteAssetLoader` (`loader.py`) reads the `manifest.json` file generated by `vite build`. This manifest maps source asset names to their hashed output filenames.
-   **Dev Server Proxy**: During development, the Litestar application does not serve the assets directly. Instead, it proxies requests to the Vite dev server, enabling Hot Module Replacement (HMR).
-   **API Calls**: For non-Inertia pages, the frontend can make standard RESTful API calls to endpoints exposed by the Litestar backend.
