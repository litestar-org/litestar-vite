# PRD: Inertia Proxy Bug Fix & Dev Server Mode

## Overview
- **Slug**: inertia-ssr-architecture
- **Created**: 2025-12-07
- **Updated**: 2025-12-07
- **Status**: In Progress (Revised)

## Problem Statement

### Bug 1: Proxy Middleware "Exception caught after response started"

The ViteProxyMiddleware and ExternalDevServerProxyMiddleware cause HTTP 500 errors with the message "Exception caught after response started" when proxying assets from the Vite dev server. This affects all proxied requests (JS, CSS, images) while direct Litestar routes work correctly.

**Environment**: litestar-fullstack-inertia, litestar-vite 0.15.0a7, Litestar 2.18.0, Granian

### Bug 2: Vite Dev Server Redirects to index.html in Inertia Mode

When running in Inertia mode with `autoDetectIndex: true` (the default), the Vite dev server finds and serves the project's `index.html` instead of showing the `dev-server-index.html` placeholder. This is problematic for Inertia apps where:

1. The backend (Litestar) is the source of truth for HTML responses
2. Direct Vite access should show a placeholder directing users to the backend URL
3. Any `index.html` in the project (e.g., from a template or leftover file) incorrectly takes precedence

## Root Cause Analysis

### Bug 1: CORRECTED Root Cause

**Previous (Incorrect) Analysis**: Response content accessed after httpx context manager exits.

**Actual Root Cause**: The httpx.AsyncClient context manager's `__aexit__` runs AFTER the ASGI response is sent.

The current code structure:
```python
async with httpx.AsyncClient(http2=http2_enabled) as client:
    upstream_resp = await client.request(...)
    response_headers = [...]
    await send({"type": "http.response.start", ...})  # response_started = True
    await send({"type": "http.response.body", ...})   # body sent
    # Context manager __aexit__ runs HERE - cleanup exceptions occur AFTER response
```

When httpx cleanup raises an exception (connection pool cleanup, HTTP/2 stream closure, network errors during close), Litestar's exception middleware detects `response_started=True` and raises the error.

**Evidence from bug report**:
- httpx request succeeds (200 OK, 179KB body)
- `receive_response_body.complete`
- `response_closed.complete`
- `close.complete`
- THEN: "Exception caught after response started"

### Bug 2: Inertia Index.html Detection

The Vite plugin's `findIndexHtmlPath()` function searches for `index.html` in:
1. Root directory
2. Resource directory
3. Public directory
4. Bundle directory

For Inertia apps, this is wrong because:
- Inertia responses are generated by the backend
- The frontend doesn't have its own `index.html` (or if it does, it's not the entry point)
- Users should be directed to access the app through Litestar, not Vite directly

## Goals

1. **Fix Bug 1**: Restructure proxy code so ASGI response is sent AFTER httpx cleanup completes
2. **Fix Bug 2**: Add Inertia mode awareness to Vite plugin's index.html handling
3. **Maintain backward compatibility**: SPA/hybrid modes continue to work unchanged

## Non-Goals

- Implementing full Inertia SSR support (separate PRD)
- Changing the overall proxy architecture
- Breaking existing SPA/hybrid mode behavior

## Acceptance Criteria

### Bug 1 (Proxy Fix)
- [ ] `ViteProxyMiddleware._proxy_http()` sends response OUTSIDE httpx context manager
- [ ] `ExternalDevServerProxyMiddleware._proxy_request()` sends response OUTSIDE httpx context manager
- [ ] Large files (>100KB) proxy successfully without 500 errors
- [ ] Existing proxy tests continue to pass
- [ ] `litestar-fullstack-inertia` reference app works in dev mode

### Bug 2 (Inertia Index Mode)
- [ ] Vite plugin accepts new `inertiaMode` option (or detects from `.litestar.json`)
- [ ] When in Inertia mode, always serve `dev-server-index.html` for `/` and `/index.html`
- [ ] Non-Inertia apps continue to auto-detect and serve their `index.html`
- [ ] Console output shows "Index Mode: Inertia" instead of "Index Mode: SPA"

## Technical Approach

### Bug 1 Fix: Restructure Proxy Code

**Current (buggy)**:
```python
async with httpx.AsyncClient(http2=http2_enabled) as client:
    try:
        upstream_resp = await client.request(...)
    except httpx.HTTPError as exc:
        await send(error_response)
        return

    # Inside context manager - send() happens before __aexit__
    response_headers = [...]
    await send({"type": "http.response.start", ...})
    await send({"type": "http.response.body", "body": upstream_resp.content})
```

**Fixed**:
```python
# Declare response variables before context manager
response_status: int
response_headers: list[tuple[bytes, bytes]]
response_body: bytes

async with httpx.AsyncClient(http2=http2_enabled) as client:
    try:
        upstream_resp = await client.request(...)
        # Read all response data while connection is open
        response_status = upstream_resp.status_code
        response_headers = [
            (k.encode(), v.encode())
            for k, v in upstream_resp.headers.items()
            if k.lower() not in _HOP_BY_HOP_HEADERS
        ]
        response_body = upstream_resp.content
    except httpx.HTTPError as exc:
        response_status = 502
        response_headers = [(b"content-type", b"text/plain")]
        response_body = str(exc).encode()

# Send response OUTSIDE context manager - httpx cleanup is complete
await send({"type": "http.response.start", "status": response_status, "headers": response_headers})
await send({"type": "http.response.body", "body": response_body})
```

### Bug 2 Fix: Inertia Mode Detection

**Option A: Explicit config in vite.config.ts**:
```typescript
litestar({
  input: ['src/main.tsx'],
  inertiaMode: true,  // New option
})
```

**Option B: Auto-detect from .litestar.json** (preferred):
```json
{
  "mode": "inertia",  // Added by InertiaPlugin
  ...
}
```

**Implementation in index.ts**:
```typescript
// In findIndexHtmlPath()
async function findIndexHtmlPath(server: ViteDevServer, pluginConfig: ResolvedPluginConfig): Promise<string | null> {
  // For Inertia mode, never auto-detect index.html
  // Users access the app through Litestar, not Vite directly
  if (pluginConfig.inertiaMode) {
    return null
  }

  if (!pluginConfig.autoDetectIndex) {
    return null
  }
  // ... existing logic
}

// In configureServer middleware
if (!indexPath && (req.url === "/" || req.url === "/index.html")) {
  // Serve dev-server-index.html placeholder
  // This is the correct behavior for Inertia apps
}
```

### Affected Files

**Python (Bug 1)**:
- `src/py/litestar_vite/plugin.py`
  - `ViteProxyMiddleware._proxy_http()` (lines 511-586)
  - `ExternalDevServerProxyMiddleware._proxy_request()` (lines 737-830)

**TypeScript (Bug 2)**:
- `src/js/src/index.ts`
  - `PluginConfig` interface - add `inertiaMode?: boolean`
  - `ResolvedPluginConfig` interface - add `inertiaMode: boolean`
  - `loadPythonDefaults()` - read mode from `.litestar.json`
  - `resolvePluginConfig()` - resolve `inertiaMode`
  - `findIndexHtmlPath()` - check `inertiaMode` flag
  - `configureServer()` middleware - update logging

**Python Config (Bug 2 support)**:
- `src/py/litestar_vite/plugin.py`
  - `_write_runtime_config_file()` - include `mode` field
- `src/py/litestar_vite/config.py`
  - Ensure `mode` is exposed in the config

## Testing Strategy

### Unit Tests
- Test proxy with response data captured inside context
- Test proxy with large response bodies (>100KB)
- Test proxy error handling paths
- Test Inertia mode flag resolution

### Integration Tests
- Run `litestar-fullstack-inertia` in dev mode
- Verify `/@vite/client` loads successfully (no 500 errors)
- Verify HMR WebSocket connects
- Verify direct Vite access shows placeholder (Inertia mode)

### Edge Cases
- Empty response bodies
- HTTP/2 vs HTTP/1.1
- Inertia mode with explicit `autoDetectIndex: false`
- Non-Inertia mode with existing index.html

## Research Questions

- [x] What causes "Exception caught after response started"? **Answer**: httpx `__aexit__` cleanup exceptions after ASGI response sent
- [x] Is the bug in both proxy middlewares? **Answer**: Yes, identical pattern
- [ ] Should we also suppress exceptions during httpx cleanup? (defense in depth)
- [x] How should Inertia mode be detected? **Answer**: From `.litestar.json` mode field

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Fix breaks existing behavior | High | Comprehensive test coverage |
| Performance regression from early body read | Low | Body was being read anyway (`upstream_resp.content`) |
| Inertia detection false positives | Medium | Explicit opt-out via `autoDetectIndex: false` |

## References

- Bug report: `/home/cody/code/litestar/litestar-vite/new_inertia_bug.md`
- Litestar Exception Middleware: `.venv/lib/python3.13/site-packages/litestar/middleware/_internal/exceptions/middleware.py`
- Reference app: `/home/cody/code/litestar/litestar-fullstack-inertia`
