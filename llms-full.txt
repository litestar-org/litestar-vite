# Litestar Vite

> Integration layer that connects the Litestar Python framework with a Vite (Node) toolchain, covering SPA, Template, and Inertia.js flows with type-safe routing and asset management.

Litestar-Vite supplies a Python plugin (`VitePlugin`) and a TypeScript Vite plugin (`litestar`) that coordinate dev/prod asset serving, HMR proxying, manifest loading, type generation, and Inertia.js. Current version: v0.14.0 (pyproject). Dual-language: Python 3.10+ backend, TypeScript frontend.

## Install
- Python: `pip install litestar-vite` (extras: `litestar-vite[jinja]` for template mode, `litestar-vite[fsspec]` for deploy backends).
- Frontend deps: run `npm install` (or bun/pnpm/yarn) in your frontend root.
- Dev server: `litestar run` starts Litestar; Vite runs automatically via proxy mode unless `VITE_PROXY_MODE=direct` is set.
- Type gen tools: `npx @hey-api/openapi-ts` invoked by the TS plugin when types are enabled.

## Project Overview
- Modes: `spa` (default, auto when `src/index.html` present), `template`, `htmx`. Auto-detects unless `mode` set.
- Proxy: default single-port (`proxy_mode=proxy`) tunnels Vite HTTP/WS through Litestar; `direct` exposes Vite separately. Hotfile at `public/hot` holds current dev URL.
- Assets: production uses Vite manifest (`public/manifest.json` by default); static served from `asset_url` (default `/static/`).
- Type generation: Python exports OpenAPI + routes; TS plugin watches and runs `@hey-api/openapi-ts`, emits HMR.

## Python API Reference
### ViteConfig (litestar_vite.config)
- Core: `mode: Literal['spa','template','htmx']|None` (auto-detect), `dev_mode: bool` shortcut â†’ runtime.dev_mode, `base_url: str|None`, `deploy: DeployConfig|bool`, `spa: SPAConfig|bool|None`, `inertia: InertiaConfig|bool`, `types: TypeGenConfig|bool` (defaults to enabled TypeGenConfig).
- Paths (PathConfig defaults): `root=Path.cwd()`, `bundle_dir=public`, `resource_dir=src`, `public_dir=public`, `manifest_name='manifest.json'`, `hot_file='hot'`, `asset_url=os.getenv('ASSET_URL','/static/')`, `ssr_output_dir=None`.
- Runtime (RuntimeConfig defaults/env): `dev_mode` (env VITE_DEV_MODE), `hot_reload` (env VITE_HOT_RELOAD True), `host='localhost'`, `port=5173`, `protocol='http'`, `executor='node'|bun|deno|yarn|pnpm`, `run_command/build_command/build_watch/install_command` auto-set per executor, `is_react`, `ssr_enabled`, `health_check` (env VITE_HEALTH_CHECK), `detect_nodeenv`, `set_environment=True`, `set_static_folders=True`, `csp_nonce`, `proxy_mode='proxy'` unless env VITE_PROXY_MODE=direct, `spa_handler=True`, `http2=True`.
- TypeGenConfig defaults: `enabled=True`, `output=Path('src/generated')`, `openapi_path=Path('src/generated/openapi.json')`, `routes_path=Path('src/generated/routes.json')`, `generate_zod=True`, `generate_sdk=False`, `watch_patterns=['**/routes.py','**/handlers.py','**/controllers/**/*.py']`.
- SPAConfig defaults: `inject_routes=True`, `inject_csrf=True`, `routes_var_name='__LITESTAR_ROUTES__'`, `csrf_var_name='__LITESTAR_CSRF__'`, `routes_include=None`, `routes_exclude=['vite_spa']`, `app_selector='#app'`, `cache_transformed_html=True`.
- InertiaConfig (config.py) defaults: `enabled=False`, `root_template='index.html'`, `include_routes=True`, `include_flash=True`, `include_errors=True`, `extra_static_page_props={}`, `extra_session_page_props=[]`.
- DeployConfig (deploy.py): created when `deploy=True`; fields include `storage_backend`, `storage_options`, `delete_orphaned`, `include_manifest`, `content_types`.

### VitePlugin (litestar_vite.plugin)
- Responsibilities: configure static routes, Jinja template callables (`vite`, `vite_static`, `vite_partial`, `vite_hmr`), start/stop Vite dev process, proxy middleware for HTTP + dedicated HMR WS handler, SPA catch-all via `ViteSPAHandler`, export types/routes on startup, inject routes into SPA HTML, manage env variables and hotfile.
- Lifespans: `server_lifespan(app)` (sync) and `async_server_lifespan(app)`; both honor `set_environment`, initialize loaders/SPA handler, optionally run Vite dev/build-watch.
- Properties: `config`, `asset_loader` (lazy `ViteAssetLoader.initialize_loader`).

### ViteAssetLoader (litestar_vite.loader)
- Initializes from manifest/hotfile, resolves asset URLs with base/asset_url, exposes `version_id` for cache busting and template helpers (`render_asset_tag`, `render_hmr_client`, `render_partial_asset_tag`, `render_static_asset`).

### Inertia Integration
- InertiaConfig (inertia/config.py): `root_template='index.html'`, `component_opt_key='component'`, `exclude_from_js_routes_key='exclude_from_routes'`, `redirect_unauthorized_to`, `redirect_404`, `extra_static_page_props: dict`, `extra_session_page_props: set[str]`, `spa_mode=False`, `app_selector='#app'`.
- InertiaPlugin (inertia/plugin.py): requires session middleware; sets `request_class=InertiaRequest`, `response_class=InertiaResponse`, registers `InertiaMiddleware`, exception handler, JS route generation on startup, adds lifespan portal for background tasks.
- InertiaResponse (inertia/response.py): constructor accepts `content`, `template_name` or `template_str`, `background`, `context`, `cookies`, `headers`, `status_code`, `media_type`; renders via template engine or SPA HtmlTransformer; handles partial reloads, deferred/merge props, CSRF injection, page props building; supports redirects via InertiaBack.

### CLI (litestar assets ...)
- `doctor [--check --fix --no-prompt --verbose]`: diagnose config and optionally auto-fix.
- `init`: scaffold frontend (`--template` choices incl. react/vue/svelte/*-inertia/htmx/angular); options for paths, SSR, tailwind, types, overwrite, no-install.
- `install`: run frontend package install.
- `build`: run Vite build with env export.
- `serve`: run Vite dev or build:watch depending on hot_reload.
- `deploy`: build (unless --no-build) then sync assets via fsspec; options `--storage`, `--storage-option key=value`, `--dry-run`, `--no-delete`.
- `export-routes`: write routes JSON (filters `--only/--except`, `--include-components`).
- `generate-types`: export OpenAPI + routes then run `@hey-api/openapi-ts`; respects TypeGenConfig and install command.
- `status`: print dev/prod status and health check Vite server.

## TypeScript API Reference (src/js/src/index.ts)
- Default export `litestar(config: string|string[]|PluginConfig): [LitestarPlugin, ...Plugin[]]`.
- PluginConfig defaults: `assetUrl='/static/'`, `bundleDirectory='public/dist'`, `resourceDirectory='resources'`, `hotFile='${bundleDirectory}/hot'`, `ssrOutputDirectory='${bundleDirectory}/bootstrap/ssr'`, `autoDetectIndex=true`, `refresh=false|paths|config`, `detectTls=null|bool|string`, `transformOnServe?: (code,url)=>string`, `input` required, `ssr?: string|string[]`.
- TypesConfig: `enabled=false`, `output='src/types/api'`, `openapiPath='openapi.json'`, `routesPath='routes.json'`, `generateZod=false`, `generateSdk=false`, `debounce=300`.
- Behavior: resolves config with defaults, writes hotfile, runs type-gen plugin when `types.enabled`, adds vite-plugin-full-reload when `refresh` set, `refreshPaths` default covers `src/**`, `resources/**`, `assets/**`.

## Examples
### SPA (React/Vue/Svelte)
```python
from litestar import Litestar
from litestar_vite import VitePlugin, ViteConfig

app = Litestar(plugins=[VitePlugin(config=ViteConfig(dev_mode=True))])
```

### Template / HTMX
```python
from litestar import Litestar
from litestar.contrib.jinja import JinjaTemplateEngine
from litestar.template.config import TemplateConfig
from litestar_vite import VitePlugin, ViteConfig

app = Litestar(
    template_config=TemplateConfig(engine=JinjaTemplateEngine(directory="templates")),
    plugins=[VitePlugin(config=ViteConfig(mode="template", dev_mode=True))],
)
```

### Inertia (template-based)
```python
from litestar import Litestar
from litestar.middleware.session.server_side import ServerSideSessionConfig, ServerSideSessionMiddleware
from litestar_vite import VitePlugin, ViteConfig
from litestar_vite.inertia import InertiaPlugin
from litestar_vite.inertia.config import InertiaConfig

app = Litestar(
    middleware=[ServerSideSessionMiddleware(config=ServerSideSessionConfig(secret="secret"))],
    plugins=[
        VitePlugin(config=ViteConfig(mode="template", inertia=True, dev_mode=True)),
        InertiaPlugin(InertiaConfig()),
    ],
)
```

### TypeScript Vite plugin
```ts
import litestar from "@litestar/vite-plugin"

export default litestar({
  input: ["src/main.ts"],
  assetUrl: "/static/",
  bundleDirectory: "public/dist",
  types: { enabled: true, output: "src/types/api", generateZod: true },
})
```

### Type Generation Workflow
1) Enable `ViteConfig(types=True)` and TS plugin `types.enabled=true`.
2) Start dev server; Litestar exports OpenAPI/routes; TS plugin watches and runs `@hey-api/openapi-ts`.
3) CI/one-off: `litestar assets generate-types`.

## Dev & Deploy Notes
- Hotfile: `bundle_dir/hot` written by TS plugin; read by proxy/HMR.
- Manifest: `bundle_dir/manifest.json` loaded by ViteAssetLoader in prod.
- Env vars: `ASSET_URL`, `VITE_BASE_URL`, `VITE_PORT`, `VITE_HOST`, `VITE_PROTOCOL`, `VITE_PROXY_MODE`, `VITE_DEV_MODE`, `VITE_HOT_RELOAD`, `VITE_HEALTH_CHECK`, `VITE_ALLOW_REMOTE`, `LITESTAR_VITE_RUNTIME`, `LITESTAR_VITE_INSTALL_CMD`, `LITESTAR_OPENAPI_PATH`.
- Deploy: `litestar assets deploy --storage gcs://bucket/path [--dry-run --no-delete --storage-option key=val]` uploads manifest/assets using fsspec; `deploy_config.storage_options` merges CLI overrides.

## Troubleshooting
- 503 from proxy: ensure Vite dev server running and hotfile exists; check `VITE_PORT`/`VITE_HOST`.
- Manifest not found: run `litestar assets build` or configure `bundle_dir`/`manifest_name`.
- Inertia 500/redirect issues: session middleware required; verify `component` route opt and `root_template`.
- Type generation skipped: confirm `types.enabled` in ViteConfig and TS plugin; install `@hey-api/openapi-ts`.
- Two-port dev needed: set `VITE_PROXY_MODE=direct` and start Vite separately.

## References
- Docs site: https://litestar-org.github.io/litestar-vite/
- README: README.md (overview, quick start, type-gen).
- Examples: examples/basic, examples/inertia, examples/spa-react.
