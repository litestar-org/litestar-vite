# Litestar Vite Reference

> Integration layer connecting Litestar (Python) with Vite (Node.js).
> Supports SPA, Template (Jinja), Inertia.js, and SSR workflows.

Current Version: **v0.15.0-rc.1**
Source: https://github.com/litestar-org/litestar-vite
Docs: https://litestar-org.github.io/litestar-vite/latest/

## Installation

```bash
# Python
pip install litestar-vite
# Extras: [jinja], [http2], [nodeenv]

# Frontend
litestar assets install
```

## Python API

### `ViteConfig`
Root configuration object passed to `VitePlugin`.

```python
from litestar_vite import ViteConfig, RuntimeConfig, PathConfig, LoggingConfig

config = ViteConfig(
    mode="spa",           # "spa", "template", "htmx", "hybrid", "ssr", "external"
                          # Aliases: "ssg" -> "ssr", "inertia" -> "hybrid"
    dev_mode=True,        # Enable HMR/Watch (default: check env VITE_DEV_MODE)
    base_url="/static/",  # CDN/Asset URL (default: env VITE_BASE_URL)
    paths=PathConfig(
        root=".",
        bundle_dir="public",
        resource_dir="src",
        public_dir="public",
        manifest_name="manifest.json",
        hot_file="hot",
        asset_url="/static/",
        ssr_output_dir=None
    ),
    runtime=RuntimeConfig(
        port=5173,
        host="127.0.0.1",
        protocol="http",
        executor="node",       # "node", "bun", "deno", "yarn", "pnpm"
        proxy_mode="vite",     # "vite" (allowlist), "proxy" (blocklist), "direct", None
        external_dev_server=None,  # ExternalDevServer config
        is_react=False,
        ssr_enabled=False,
        health_check=False,
        detect_nodeenv=False,
        set_environment=True,
        set_static_folders=True,
        csp_nonce=None,
        spa_handler=True,
        http2=True,
        start_dev_server=True
    ),
    # Feature flags
    types=True,           # Enable type generation (TypeGenConfig)
    inertia=True,         # Enable Inertia.js (InertiaConfig)
    spa=True,             # Enable SPA transformations (SPAConfig)
    deploy=False,         # Enable CDN deployment (DeployConfig)
    logging=LoggingConfig(level="normal"), # Logging settings
    
    # Advanced
    guards=None,          # Guards for SPA catch-all route
    exclude_static_from_auth=True, # Exclude static assets from auth middleware
    spa_path=None,        # Path to serve SPA (default: "/")
    include_root_spa_paths=False # Also serve at "/" if spa_path is non-root
)
```

### `InertiaConfig`
Configuration for InertiaJS support.

```python
from litestar_vite import InertiaConfig, InertiaSSRConfig, InertiaTypeGenConfig

config = InertiaConfig(
    root_template="index.html",
    component_opt_keys=("component", "page"),
    redirect_unauthorized_to=None,
    redirect_404=None,
    extra_static_page_props={},
    extra_session_page_props=set(),
    encrypt_history=False,  # Enable v2 browser history encryption (Requires Inertia v2)
    type_gen=InertiaTypeGenConfig(
        include_default_auth=True,
        include_default_flash=True
    ),
    ssr=InertiaSSRConfig(   # Enable Inertia SSR
        enabled=True,
        url="http://127.0.0.1:13714/render",
        timeout=2.0
    ) # Requires running external Node SSR server
)
```

### `TypeGenConfig`
Type generation settings.

```python
from litestar_vite import TypeGenConfig

types = TypeGenConfig(
    output=Path("src/generated"),
    openapi_path=None,        # Auto: output / "openapi.json"
    routes_path=None,         # Auto: output / "routes.json"
    routes_ts_path=None,      # Auto: output / "routes.ts"
    page_props_path=None,     # Auto: output / "inertia-pages.json"
    generate_zod=False,
    generate_sdk=True,
    generate_routes=True,
    generate_page_props=True,
    global_route=False,       # Register route() globally on window
    watch_patterns=["**/routes.py", "**/handlers.py", "**/controllers/**/*.py"]
)
```

### `SPAConfig`
SPA HTML transformation settings.

```python
from litestar_vite.config import SPAConfig

spa = SPAConfig(
    inject_csrf=True,
    csrf_var_name="__LITESTAR_CSRF__",
    app_selector="#app",
    cache_transformed_html=True  # Disabled when inject_csrf=True
)
```

### `DeployConfig`
CDN deployment configuration.

```python
from litestar_vite import DeployConfig

deploy = DeployConfig(
    enabled=True,
    storage_backend="gcs://bucket/path",  # fsspec URL (env VITE_DEPLOY_STORAGE)
    storage_options={},  # Provider options (credentials, region)
    delete_orphaned=True,
    include_manifest=True,
    content_types={".js": "application/javascript", ...}
)
```

### `VitePlugin`
Main application plugin.

```python
from litestar import Litestar
from litestar_vite import VitePlugin

app = Litestar(plugins=[VitePlugin(config=config)])
```

### `InertiaPlugin`
Inertia.js protocol integration. Automatically added if `inertia` is configured in `VitePlugin`.

### `ViteSPAHandler`
Handles serving SPA HTML (dev proxying + prod caching).
- **Dev**: Proxies requests to Vite.
- **Prod**: Serves cached `index.html` with injected CSRF/Page Data.

### Inertia Helpers (Python)

```python
from litestar_vite.inertia import (
    share, lazy, defer, merge, flash, error,
    only, except_, clear_history, scroll_props,
    get_shared_props, extract_deferred_props, extract_merge_props
)

# Share props globally
share(request, "user", current_user)

# Lazy props (v1 style)
lazy("permissions", lambda: Permission.all())

# Deferred props (Requires Inertia v2)
defer("notifications", fetch_notifications, group="sidebar")

# Merge props
merge("filters", current_filters)

# Flash messages
flash(request, "success", "Item saved!")

# Validation errors
error(request, "email", "Email is required")

# History encryption (Requires Inertia v2)
clear_history()  # Clear encrypted history on next response

# Infinite scroll props (Requires Inertia v2)
scroll_props(items, total=100, limit=20, offset=0)
```

### Inertia Response Classes

```python
from litestar_vite.inertia import (
    InertiaResponse, InertiaRedirect, InertiaBack, InertiaExternalRedirect
)

@get("/dashboard", component="Dashboard")
async def dashboard() -> InertiaResponse:
    return InertiaResponse(
        {"stats": get_stats()},
        encrypt_history=True,  # Override global setting (Requires Inertia v2)
        clear_history=False
    )
```

## TypeScript API

### `litestar-vite-plugin`
Vite plugin for `vite.config.ts`.

```typescript
import litestar from "litestar-vite-plugin";

export default defineConfig({
  plugins: [
    litestar({
      input: ["src/main.ts"],
      assetUrl: "/static/",
      bundleDir: "public",
      resourceDir: "src",
      publicDir: "public",
      hotFile: "public/hot",
      ssr: undefined,
      ssrOutDir: undefined,
      refresh: false,
      detectTls: false,
      autoDetectIndex: true,
      inertiaMode: false,       // Auto-detected
      types: "auto",            // "auto" | true | false | TypesConfig
      executor: undefined
    })
  ]
});
```

### TypeScript Helpers

**`litestar-vite-plugin/helpers`**:
```typescript
import {
  getCsrfToken,
  csrfHeaders,
  csrfFetch,
  addDirective,        // HTMX
  registerHtmxExtension,
  setHtmxDebug,
  swapJson
} from "litestar-vite-plugin/helpers"
```

**`litestar-vite-plugin/inertia-helpers`**:
```typescript
import {
  resolvePageComponent,
  unwrapPageProps,
} from "litestar-vite-plugin/inertia-helpers"

// Resolve page component
createInertiaApp({
  resolve: (name) => resolvePageComponent(
    `./pages/${name}.vue`,
    import.meta.glob('./pages/**/*.vue')
  ),
  // ...
})
```

### Generated Routes (from `litestar assets generate-types`)

```typescript
// src/generated/routes.ts
import { route, hasRoute } from "@/generated/routes"

const url = route("user:detail", { user_id: 123 })
```

### Generated Page Props (from `litestar assets generate-types`)

```typescript
// src/generated/page-props.ts
import type { PageProps } from "@/generated/page-props"
type DashboardProps = PageProps["Dashboard"]
```

## CLI Commands (`litestar assets`)

| Command | Description |
|---------|-------------|
| `install` | Install frontend dependencies. |
| `serve` | Run dev server (proxies if configured). |
| `build` | Build frontend assets for production. |
| `init` | Scaffold new frontend. |
| `doctor` | Diagnose configuration issues. |
| `generate-types` | Generate TS types and OpenAPI. |
| `export-routes` | Export routes.json/routes.ts manually. |
| `deploy` | Upload assets to object storage. |
| `status` | Check Vite integration status. |

## Bridge Configuration (`.litestar.json`)

The Python plugin writes `.litestar.json` on startup. The Vite plugin reads this for defaults.

```json
{
  "assetUrl": "/static/",
  "bundleDir": "public",
  "resourceDir": "src",
  "mode": "spa",
  "proxyMode": "vite",
  "port": 5173,
  ...
}
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `VITE_DEV_MODE` | Enable development mode | `False` |
| `VITE_PROXY_MODE` | Proxy strategy | `vite` |
| `VITE_HOST` | Dev server host | `127.0.0.1` |
| `VITE_PORT` | Dev server port | `5173` |
| `ASSET_URL` | Static asset base URL | `/static/` |
| `VITE_AUTO_DEV_MODE` | Auto-enable dev if no assets | `True` |
| `VITE_DEPLOY_STORAGE` | fsspec URL for deployment | None |
| `LITESTAR_VITE_LOG_LEVEL` | Logging verbosity | `normal` |
