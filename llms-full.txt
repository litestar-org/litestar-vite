# Litestar Vite

> Integration layer that connects the Litestar Python framework with a Vite (Node) toolchain, covering SPA, Template, and Inertia.js flows with type-safe routing and asset management.

Litestar-Vite supplies a Python plugin (`VitePlugin`) and a TypeScript Vite plugin (`litestar`) that coordinate dev/prod asset serving, HMR proxying, manifest loading, type generation, and Inertia.js. Current version: v0.15.0-alpha.3 (pyproject). Dual-language: Python 3.10+ backend, TypeScript frontend.

## Install
- Python: `pip install litestar-vite` (extras: `litestar-vite[jinja]` for template mode, `litestar-vite[http2]` for HTTP/2 proxy, `litestar-vite[nodeenv]` for virtualenv node).
- Frontend deps: run `litestar assets install` (preferred; uses configured executor) or npm/pnpm/yarn in your frontend root.
- Dev server: `litestar run` starts Litestar; Vite runs automatically via proxy mode unless `VITE_PROXY_MODE=vite_direct` is set.
- Type gen tools: `npx @hey-api/openapi-ts` invoked by the TS plugin when types are enabled.

## Project Overview
- Modes: `spa` (default, auto when `src/index.html` present), `template`, `htmx`. Auto-detects unless `mode` set.
- Proxy Modes: `proxy_mode` controls how proxy requests are handled:
  - `vite_proxy` (default): Single-port, tunnels Vite HTTP/WS through Litestar with full HMR
  - `vite_direct`: Multi-port, exposes Vite on its own port
  - `external_proxy`: Proxy to external dev servers (Angular CLI, Next.js, CRA) via `ExternalDevServer` config
- Hotfile: `public/hot` holds current dev URL, written by TS plugin.
- Assets: production uses Vite manifest (`public/manifest.json` by default); static served from `asset_url` (default `/static/`).
- Type generation: Python exports OpenAPI + routes; TS plugin watches and runs `@hey-api/openapi-ts`, emits HMR.

## Python API Reference

### Main Exports (litestar_vite)
- `VitePlugin` - Main plugin class
- `ViteConfig` - Root configuration
- `PathConfig` - File system paths configuration
- `RuntimeConfig` - Runtime execution settings
- `TypeGenConfig` - Type generation settings
- `SPAConfig` - SPA HTML transformation settings
- `InertiaConfig` - Inertia.js settings (also at `litestar_vite.inertia.InertiaConfig`)
- `DeployConfig` - Deployment configuration
- `ExternalDevServer` - External dev server proxy configuration
- `ViteAssetLoader` - Asset loading utilities
- `ViteSPAHandler` - SPA HTML handler class
- `HtmlTransformer` - HTML transformation utilities
- `RouteMetadata`, `extract_route_metadata`, `generate_routes_json` - Codegen utilities
- `inertia` - Inertia submodule

### ViteConfig (litestar_vite.config)
- Core: `mode: Literal['spa','template','htmx']|None` (auto-detect), `dev_mode: bool` shortcut → runtime.dev_mode, `base_url: str|None`, `deploy: DeployConfig|bool`, `spa: SPAConfig|bool|None`, `inertia: InertiaConfig|bool`, `types: TypeGenConfig|bool`.
- Paths (PathConfig defaults): `root=Path.cwd()`, `bundle_dir=public`, `resource_dir=src`, `public_dir=public`, `manifest_name='manifest.json'`, `hot_file='hot'`, `asset_url=os.getenv('ASSET_URL','/static/')`, `ssr_output_dir=None`.
- Runtime (RuntimeConfig defaults/env): `dev_mode` (env VITE_DEV_MODE), `proxy_mode` (env VITE_PROXY_MODE, default 'vite_proxy'), `external_dev_server: ExternalDevServer|str|None`, `host='localhost'`, `port=5173`, `protocol='http'`, `executor='node'|bun|deno|yarn|pnpm`, `run_command/build_command/build_watch_command/install_command` auto-set per executor, `is_react`, `ssr_enabled`, `health_check` (env VITE_HEALTH_CHECK), `detect_nodeenv`, `set_environment=True`, `set_static_folders=True`, `csp_nonce`, `spa_handler=True`, `http2=True`, `start_dev_server=True`.
- TypeGenConfig defaults: `enabled=False`, `output=Path('src/generated')`, `openapi_path=Path('src/generated/openapi.json')`, `routes_path=Path('src/generated/routes.json')`, `generate_zod=True`, `generate_sdk=False`, `watch_patterns=['**/routes.py','**/handlers.py','**/controllers/**/*.py']`.
- SPAConfig defaults: `inject_routes=True`, `inject_csrf=True`, `routes_var_name='__LITESTAR_ROUTES__'`, `csrf_var_name='__LITESTAR_CSRF__'`, `routes_include=None`, `routes_exclude=['vite_spa']`, `app_selector='#app'`, `cache_transformed_html=True`.
- InertiaConfig (config.py) defaults: `enabled=False`, `root_template='index.html'`, `include_routes=True`, `include_flash=True`, `include_errors=True`, `extra_static_page_props={}`, `extra_session_page_props=[]`.
- ExternalDevServer: `target='http://localhost:4200'`, `http2=False`, `enabled=True`. Use for Angular CLI, Next.js, CRA, etc.
- DeployConfig (deploy.py): created when `deploy=True`; fields include `storage_backend`, `storage_options`, `delete_orphaned`, `include_manifest`, `content_types`.

### VitePlugin (litestar_vite.plugin)
- Responsibilities: configure static routes, Jinja template callables (`vite`, `vite_static`, `vite_partial`, `vite_hmr`), start/stop Vite dev process, proxy middleware for HTTP + dedicated HMR WS handler, SPA catch-all via `ViteSPAHandler`, export types/routes on startup, inject routes into SPA HTML, manage env variables and hotfile.
- Lifespans: `server_lifespan(app)` (sync, runs ONCE per server) for Vite process and env setup; `lifespan(app)` (async, auto-registered, runs per worker) for SPA handler and asset loader initialization.
- Properties: `config`, `asset_loader` (lazy `ViteAssetLoader.initialize_loader`).

### ViteAssetLoader (litestar_vite.loader)
- Initializes from manifest/hotfile, resolves asset URLs with base/asset_url, exposes `version_id` for cache busting and template helpers (`render_asset_tag`, `render_hmr_client`, `render_partial_asset_tag`, `render_static_asset`).

### ViteSPAHandler (litestar_vite.spa)
- Serves SPA HTML in dev (proxies to Vite) and production (cached from disk).
- Methods: `initialize()`, `shutdown()`, `get_html(request, page_data=None)`, `get_html_sync(page_data=None, csrf_token=None)`, `get_bytes()`, `set_routes_metadata(routes)`, `create_route_handler()`.
- Applies transformations: route metadata injection, CSRF token injection, Inertia page data injection.
- Uses `HtmlTransformer` for HTML manipulation.

### HtmlTransformer (litestar_vite.html_transform)
- Static methods for HTML manipulation: `inject_json_script()`, `inject_head_script()`, `set_data_attribute()`.
- Used by ViteSPAHandler and InertiaResponse for consistent HTML transformations.

### Inertia Integration (litestar_vite.inertia)
- InertiaConfig: `root_template='index.html'`, `component_opt_keys=('component', 'page')` (tuple of keys to check for component name), `exclude_from_js_routes_key='exclude_from_routes'`, `redirect_unauthorized_to`, `redirect_404`, `extra_static_page_props: dict`, `extra_session_page_props: set[str]`, `spa_mode=False`, `app_selector='#app'`.
- InertiaPlugin: requires session middleware; sets `request_class=InertiaRequest`, `response_class=InertiaResponse`, registers `InertiaMiddleware`, exception handler, JS route generation on startup, adds lifespan portal for background tasks.
- InertiaRequest: extends Litestar Request with `inertia` property containing headers and details.
- InertiaResponse: constructor accepts `content`, `template_name` or `template_str`, `background`, `context`, `cookies`, `headers`, `status_code`, `media_type`; renders via template engine or SPA HtmlTransformer; handles partial reloads, deferred/merge props, CSRF injection, page props building.
- Redirect helpers: `InertiaRedirect`, `InertiaBack`, `InertiaExternalRedirect`.
- Props helpers: `share()`, `lazy()`, `defer()`, `merge()`, `error()`, `get_shared_props()`, `extract_deferred_props()`, `extract_merge_props()`.
- Route helpers: `generate_js_routes()`, `js_routes_script()`.
- Exception handling: `create_inertia_exception_response()`, `exception_to_http_response()`.

### CLI (litestar assets ...)
- `doctor [--check --fix --no-prompt --verbose]`: diagnose config and optionally auto-fix.
- `init`: scaffold frontend (`--template` choices: react, react-router, react-tanstack, react-inertia, vue, vue-inertia, svelte, svelte-inertia, sveltekit, nuxt, astro, htmx, angular, angular-cli); options for paths, SSR, tailwind, types, overwrite, no-install.
- `install`: run frontend package install.
- `build`: run Vite build with env export.
- `serve`: run Vite dev or build:watch depending on hot_reload.
- `deploy`: build (unless --no-build) then sync assets via fsspec; options `--storage`, `--storage-option key=value`, `--dry-run`, `--no-delete`.
- `export-routes`: write routes JSON (filters `--only/--except`, `--include-components`).
- `generate-types`: export OpenAPI + routes then run `@hey-api/openapi-ts`; respects TypeGenConfig and install command.
- `status`: print dev/prod status and health check Vite server.

## TypeScript API Reference (src/js/src/index.ts)
- Default export `litestar(config: string|string[]|PluginConfig): [LitestarPlugin, ...Plugin[]]`.
- PluginConfig defaults: `assetUrl='/static/'`, `bundleDirectory='public/dist'`, `resourceDirectory='resources'`, `hotFile='${bundleDirectory}/hot'`, `ssrOutputDirectory='${bundleDirectory}/bootstrap/ssr'`, `autoDetectIndex=true`, `refresh=false|paths|config`, `detectTls=null|bool|string`, `transformOnServe?: (code,url)=>string`, `input` required, `ssr?: string|string[]`.
- TypesConfig: `enabled=false`, `output='src/types/api'`, `openapiPath='openapi.json'`, `routesPath='routes.json'`, `generateZod=false`, `generateSdk=false`, `debounce=300`.
- Behavior: resolves config with defaults, writes hotfile, runs type-gen plugin when `types.enabled`, adds vite-plugin-full-reload when `refresh` set, `refreshPaths` default covers `src/**`, `resources/**`, `assets/**`.

### Package Exports (package.json)
- `litestar-vite-plugin` - Main plugin
- `litestar-vite-plugin/helpers` - Route and CSRF helpers
- `litestar-vite-plugin/inertia-helpers` - Inertia.js helpers
- `litestar-vite-plugin/astro` - Astro integration
- `litestar-vite-plugin/sveltekit` - SvelteKit integration
- `litestar-vite-plugin/nuxt` - Nuxt integration

### Helpers (litestar-vite-plugin/helpers)
- `getCsrfToken()`: Get CSRF token from window or meta tag
- `csrfHeaders()`: Get headers object with CSRF token
- `csrfFetch(url, options)`: Fetch wrapper with CSRF token
- `route(name, params)`: Generate URL from route name
- `getRoutes()`: Get all routes from window.__LITESTAR_ROUTES__
- `toRoute(name, params)`: Navigate to route
- `currentRoute()`: Get current route info
- `isRoute(name)`: Check if route matches
- `isCurrentRoute(name)`: Check if current route matches
- `getRelativeUrlPath(url)`: Extract path from URL

### Inertia Helpers (litestar-vite-plugin/inertia-helpers)
- Re-exports all from `/helpers`
- `resolvePageComponent(path, pages)`: Resolve Inertia page component from glob import

### SSR Framework Integrations

#### Astro Integration (litestar-vite-plugin/astro)
```typescript
// astro.config.mjs
import { defineConfig } from 'astro/config';
import litestar from 'litestar-vite-plugin/astro';

export default defineConfig({
  integrations: [
    litestar({
      apiProxy: 'http://localhost:8000',
      apiPrefix: '/api',
      typesPath: './src/generated/api',
      verbose: false,
    }),
  ],
});
```
- `LitestarAstroConfig`: `apiProxy` (default `http://localhost:8000`), `apiPrefix` (`/api`), `typesPath` (`./src/types/api`), `openapiPath`, `routesPath`, `verbose`.
- Proxies API requests to Litestar backend during dev.
- Writes hotfile for ViteSPAHandler compatibility.
- Usage in pages: `import { route } from '../generated/api/routes'; const url = route('users.show', { id });`

#### SvelteKit Integration (litestar-vite-plugin/sveltekit)
```typescript
// vite.config.ts
import { sveltekit } from '@sveltejs/kit/vite';
import { litestarSvelteKit } from 'litestar-vite-plugin/sveltekit';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [
    litestarSvelteKit({
      apiProxy: 'http://localhost:8000',
      apiPrefix: '/api',
      types: {
        enabled: true,
        output: 'src/lib/api',
        generateZod: true,
        debounce: 300,
      },
    }),
    sveltekit(),  // Must come AFTER litestarSvelteKit
  ],
});
```
- `LitestarSvelteKitConfig`: `apiProxy`, `apiPrefix`, `types` (boolean|`SvelteKitTypesConfig`), `verbose`.
- `SvelteKitTypesConfig`: `enabled`, `output` (`src/lib/api`), `openapiPath`, `routesPath`, `generateZod`, `debounce`.
- Usage in load functions: `import type { User } from '$lib/api/types.gen'; const response = await fetch(route('users.show', { id: params.id }));`

#### Nuxt Integration (litestar-vite-plugin/nuxt)
```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  modules: ['litestar-vite-plugin/nuxt'],
  litestar: {
    apiProxy: 'http://localhost:8000',
    apiPrefix: '/api',
    types: {
      enabled: true,
      output: 'types/api',
      generateZod: false,
    },
  },
});
```
- `LitestarNuxtConfig`: `apiProxy`, `apiPrefix`, `types` (boolean|`NuxtTypesConfig`), `verbose`.
- `NuxtTypesConfig`: `enabled`, `output` (`types/api`), `openapiPath`, `routesPath`, `generateZod`, `debounce`.
- Alternatively use `litestarPlugins()` in `vite.plugins` for manual setup.
- Usage in composables: `import type { User } from '~/types/api/types.gen'; const { data } = await useFetch<User>(route('users.show', { id }));`

#### SSR Integration Pattern Summary
All SSR integrations share:
- API proxy during development (no CORS issues)
- Type generation via `@hey-api/openapi-ts` with HMR
- Hotfile writing for ViteSPAHandler compatibility
- Reads `LITESTAR_VITE_CONFIG_PATH` for runtime config sync

## Examples
All examples in `examples/` directory:
- `angular/` - Angular with Vite
- `angular-cli/` - Angular CLI with external proxy mode
- `astro/` - Astro with Litestar API backend
- `basic/` - Basic Jinja template mode
- `flash/` - Flash messages example
- `fullstack-typed/` - Full-stack typed routes and API
- `jinja/` - Jinja templates with Vite assets
- `nuxt/` - Nuxt 3 with Litestar API
- `react/` - React SPA with Vite
- `react-inertia/` - React with Inertia.js (SPA mode)
- `react-inertia-jinja/` - React with Inertia.js (Jinja templates)
- `svelte/` - Svelte SPA
- `sveltekit/` - SvelteKit with Litestar API
- `template-htmx/` - HTMX with Jinja templates
- `vue/` - Vue 3 SPA
- `vue-inertia/` - Vue 3 with Inertia.js (SPA mode)
- `vue-inertia-jinja/` - Vue 3 with Inertia.js (Jinja templates)

### SPA (React/Vue/Svelte)
```python
from litestar import Litestar
from litestar_vite import VitePlugin, ViteConfig

app = Litestar(plugins=[VitePlugin(config=ViteConfig(dev_mode=True))])
```

### Template / HTMX
```python
from litestar import Litestar
from litestar.contrib.jinja import JinjaTemplateEngine
from litestar.template.config import TemplateConfig
from litestar_vite import VitePlugin, ViteConfig

app = Litestar(
    template_config=TemplateConfig(engine=JinjaTemplateEngine(directory="templates")),
    plugins=[VitePlugin(config=ViteConfig(mode="template", dev_mode=True))],
)
```

### Inertia (template-based)
```python
from litestar import Litestar
from litestar.middleware.session.server_side import ServerSideSessionConfig, ServerSideSessionMiddleware
from litestar_vite import VitePlugin, ViteConfig
from litestar_vite.inertia import InertiaPlugin, InertiaConfig

app = Litestar(
    middleware=[ServerSideSessionMiddleware(config=ServerSideSessionConfig(secret="secret"))],
    plugins=[
        VitePlugin(config=ViteConfig(mode="template", inertia=True, dev_mode=True)),
        InertiaPlugin(InertiaConfig()),
    ],
)
```

### External Dev Server (Angular CLI)
```python
from litestar_vite import ViteConfig, RuntimeConfig, ExternalDevServer

config = ViteConfig(
    dev_mode=True,
    runtime=RuntimeConfig(
        proxy_mode="external_proxy",
        external_dev_server=ExternalDevServer(target="http://localhost:4200"),
    ),
)
```

### TypeScript Vite plugin
```ts
import litestar from "litestar-vite-plugin"

export default litestar({
  input: ["src/main.ts"],
  assetUrl: "/static/",
  bundleDirectory: "public/dist",
  types: { enabled: true, output: "src/types/api", generateZod: true },
})
```

### Type Generation Workflow
1) Enable `ViteConfig(types=True)` and TS plugin `types.enabled=true`.
2) Start dev server; Litestar exports OpenAPI/routes; TS plugin watches and runs `@hey-api/openapi-ts`.
3) CI/one-off: `litestar assets generate-types`.

### Doctor command
- `litestar assets doctor [--check --fix --no-prompt --verbose]`
- `litestar assets install` — install frontend deps with configured executor (npm/pnpm/yarn/bun)
- Prints Python vs vite.config snapshot (asset URLs, bundle/hot paths, mode, host/port, types flags).
- Flags: hot file missing (dev proxy), manifest missing (prod), type-gen exports missing, env/config mismatches, plugin install/dist missing.
- `--fix` rewrites simple vite.config values (assetUrl, bundleDirectory, hotFile, type paths) after creating a backup.

## Dev & Deploy Notes
- Hot file: `bundle_dir/hot` written by TS plugin; read by proxy/HMR.
- Manifest: `bundle_dir/manifest.json` loaded by ViteAssetLoader in prod.
- Env vars: `ASSET_URL`, `VITE_BASE_URL`, `VITE_PORT`, `VITE_HOST`, `VITE_PROTOCOL`, `VITE_PROXY_MODE`, `VITE_DEV_MODE`, `VITE_HOT_RELOAD`, `VITE_HEALTH_CHECK`, `VITE_ALLOW_REMOTE`, `VITE_AUTO_DEV_MODE`, `LITESTAR_VITE_CONFIG_PATH`, `LITESTAR_OPENAPI_PATH`.
- Deploy: `litestar assets deploy --storage gcs://bucket/path [--dry-run --no-delete --storage-option key=val]` uploads manifest/assets using fsspec; `deploy_config.storage_options` merges CLI overrides.

## Troubleshooting
- 503 from proxy: ensure Vite dev server running and hotfile exists; check `VITE_PORT`/`VITE_HOST`.
- Manifest not found: run `litestar assets build` or configure `bundle_dir`/`manifest_name`.
- Inertia 500/redirect issues: session middleware required; verify `component` route opt and `root_template`.
- Type generation skipped: confirm `types.enabled` in ViteConfig and TS plugin; install `@hey-api/openapi-ts`.
- Two-port dev needed: set `VITE_PROXY_MODE=vite_direct` and start Vite separately.
- External dev server (Angular/Next.js): use `proxy_mode="external_proxy"` with `ExternalDevServer`.

## Migration Guide (v0.14.x → v0.15.x)

### Breaking Changes

#### `proxy_mode` values expanded
The `proxy_mode` values have been expanded with a new `external_proxy` option:

**Before (v0.14.x):**
```python
ViteConfig(runtime=RuntimeConfig(proxy_mode="proxy"))  # or "direct"
```

**After (v0.15.x):**
```python
ViteConfig(runtime=RuntimeConfig(proxy_mode="vite_proxy"))  # or "vite_direct", "external_proxy"
```

Value mapping:
| Old (v0.14) | New (v0.15) | Description |
|-------------|-------------|-------------|
| `"proxy"` | `"vite_proxy"` | Single-port proxy (default) |
| `"direct"` | `"vite_direct"` | Multi-port, separate Vite server |
| N/A | `"external_proxy"` | Proxy to external dev servers |

Environment variable: `VITE_PROXY_MODE` (unchanged)

#### New `ExternalDevServer` config
For Angular CLI, Next.js, or other external dev servers:
```python
from litestar_vite import ViteConfig, RuntimeConfig, ExternalDevServer

config = ViteConfig(
    dev_mode=True,
    runtime=RuntimeConfig(
        proxy_mode="external_proxy",
        external_dev_server=ExternalDevServer(target="http://localhost:4200"),
    ),
)
```

### New Features in v0.15
- `ViteSPAHandler` class for programmatic SPA HTML handling
- `HtmlTransformer` for HTML manipulation utilities
- SSR framework integrations (`/astro`, `/sveltekit`, `/nuxt`)
- `inject_csrf=True` default in SPAConfig
- `start_dev_server` flag in RuntimeConfig
- Expanded CLI templates (14 total including angular-cli, astro, sveltekit, nuxt)

### Deprecations
- None in v0.15

## References
- Docs site: https://litestar-org.github.io/litestar-vite/
- README: README.md (overview, quick start, type-gen).
- Examples: See Examples section above for all available examples.
